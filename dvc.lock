schema: '2.0'
stages:
  preview:
    cmd: python3 src/2_preview.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
    - path: src/2_preview.py
      hash: md5
      md5: 27bc48612e83e558f6e6b898717cd582
      size: 2244
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
    outs:
    - path: data/preview
      hash: md5
      md5: e1ae8b24fca2b0b0332fb319bc06cab6.dir
      size: 4165248
      nfiles: 16
  train:
    cmd: python3 src/2_train.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
    - path: src/2_train.py
      hash: md5
      md5: 45b1b032bed61ea60ed27d0c35cc1b5d
      size: 3914
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
        train.model:
          seed: 42
          num_classes: 1
        train.training:
          lr: 0.001
          lr_decay_rate: 0.0005
          lr_sched_step_size:
          lr_sched_gamma:
          save_ckpt: false
          es_patience:
          epochs: 2
          precision: 16-mixed
    outs:
    - path: lightning_logs
      hash: md5
      md5: 5d7fdd7864b505e50527543ef22a26f0.dir
      size: 594761837
      nfiles: 4
    - path: out/metrics.json
      hash: md5
      md5: 259220746ec959248c69189b250c10fe
      size: 209
    - path: out/model.ckpt
      hash: md5
      md5: 940f9bc51b3c8cf8ba4a1624ce654576
      size: 297377218
  evaluate:
    cmd: python3 src/3_evaluate.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: 940f9bc51b3c8cf8ba4a1624ce654576
      size: 297377218
    - path: src/3_evaluate.py
      hash: md5
      md5: aa0a225ffcc88fab519022970665c537
      size: 2397
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
    outs:
    - path: data/evaluate
      hash: md5
      md5: 52ee48f0ac9898157b6c0b105613b6ab.dir
      size: 2420224
      nfiles: 10
  prepare:
    cmd: python3 src/0_prepare.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_prepare.py
      hash: md5
      md5: 0c360e59d6219194572d25f492ffe630
      size: 1085
    params:
      params.yaml:
        prepare:
          src_bucket: swissimage-0.1m
          s3_src_vrt_path: files.vrt
          s3_dest_prepared_path: data/prepared
          commune_name: Nyon
          commune_x_ratio: 0.66
          commune_y_ratio: 0.75
          tile_size: 1024
    outs:
    - path: data/prepared/depends.txt
      hash: md5
      md5: b04bb8a84303df415975f0342f6c6452
      size: 86
  detect:
    cmd: python3 src/detect_tif.py
    deps:
    - path: data/raw/nyon.tif
      hash: md5
      md5: bc7ea13eb06a246207e8fba8fec1a82b
      size: 3679034256
    - path: out/model.ckpt
      hash: md5
      md5: 323fa405a58cbbdc6bc2714e1ecadf7f
      size: 345578472
    - path: src/detect_tif.py
      hash: md5
      md5: 55b60bb2755cef959e916c19dfb523c2
      size: 7263
    params:
      params.yaml:
        datamodule.batch_size: 16
        datamodule.image_size: 384
        train.seed: 42
    outs:
    - path: out/nyon_solar.gpkg
      hash: md5
      md5: 21947923c7a23dae7611e8b053fe6685
      size: 311296
  export:
    cmd: python3 src/3_export.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: 940f9bc51b3c8cf8ba4a1624ce654576
      size: 297377218
    - path: src/3_export.py
      hash: md5
      md5: 0fcafcbfffa0da35a86967e045822621
      size: 2713
    params:
      params.yaml:
        export.model_name: solar_model_gpu
        train.datamodule.setup.batch_size: 16
        train.datamodule.setup.image_size: 384
    outs:
    - path: out/solar_model_gpu.bentomodel
      hash: md5
      md5: 218aac2645ae96da0c51f4a1634b35a9
      size: 154247492
  extract_tiles:
    cmd: python3 src/0_extract_tiles.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_extract_tiles.py
      hash: md5
      md5: d8f3c3f85cb8ce0f03bc2f5cb6d268f2
      size: 5549
    params:
      params.yaml:
        extract_tiles:
          commune_name: Nyon
          x_ratio: 0.66
          y_ratio: 0.75
          tile_size: 1024
          overlap_size: 0
    outs:
    - path: data/extracted
      hash: md5
      md5: 21ebad90556c18bcb102a899cbaec28a.dir
      size: 2232518327
      nfiles: 1110
  pull_labels:
    cmd: python3 src/1_pull_labels.py
    deps:
    - path: src/1_pull_labels.py
      hash: md5
      md5: 9a8d04cb37fda408fb573066a7f58d3d
      size: 196
    outs:
    - path: data/labels/annotations.json
      hash: md5
      md5: d751713988987e9331980363e24189ce
      size: 2
  preprocess:
    cmd: python3 src/1_preprocess.py
    deps:
    - path: src/1_preprocess.py
      hash: md5
      md5: aa699e9faef007f37a7aac0129c4f4ff
      size: 2312
    outs:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
