schema: '2.0'
stages:
  prepare:
    cmd: python3 src/0_prepare.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_prepare.py
      hash: md5
      md5: 0c360e59d6219194572d25f492ffe630
      size: 1085
    params:
      params.yaml:
        prepare:
          src_bucket: swissimage-0.1m
          s3_src_vrt_path: files.vrt
          s3_dest_prepared_path: data/prepared
          commune_name: Nyon
          commune_x_ratio: 0.66
          commune_y_ratio: 0.75
          tile_size: 1024
  pre-train:
    cmd: python3 src/0_pre_train.py
    deps:
    - path: data/raw/bdappv.zip
      hash: md5
      md5: 451493b63927342d1dc54a365f136302
      size: 8185439624
    - path: src/0_pre_train.py
      hash: md5
      md5: 30dd3851958fa91109994bc71bacf571
      size: 3946
    params:
      params.yaml:
        pre-train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
        pre-train.model:
          seed: 64
          num_classes: 1
          freeze_backbone: false
        pre-train.training:
          lr: 0.00025
          lr_decay_rate: 0.0005
          lr_sched_step_size: 1
          lr_sched_gamma: 0.7
          save_ckpt: false
          es_patience:
          epochs: 5
          precision: 32-true
    outs:
    - path: out/pretrained/lightning_logs
      hash: md5
      md5: 83129846d42104cd1aaeae1d7b7d1108.dir
      size: 971165733
      nfiles: 4
    - path: out/pretrained/metrics.json
      hash: md5
      md5: 5f90458007b9199e00118697fe240814
      size: 259
    - path: out/pretrained/model.ckpt
      hash: md5
      md5: 84e100b133e3f568be8f55e603cabbde
      size: 485571270
  preprocess:
    cmd: python3 src/1_preprocess.py
    deps:
    - path: src/1_preprocess.py
      hash: md5
      md5: aa699e9faef007f37a7aac0129c4f4ff
      size: 2312
    outs:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
  preview:
    cmd: python3 src/2_preview.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
    - path: src/2_preview.py
      hash: md5
      md5: d0d0efa31968c77025bc025e80eec7a6
      size: 2251
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
    outs:
    - path: data/preview
      hash: md5
      md5: ecec96b4618d95382024b9199e80d80d.dir
      size: 1852429
      nfiles: 16
  train:
    cmd: python3 src/2_train.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 8a76227e024c4e6d7ffc0fd630c8d332
      size: 10515
    - path: out/pretrained/model.ckpt
      hash: md5
      md5: 84e100b133e3f568be8f55e603cabbde
      size: 485571270
    - path: src/2_train.py
      hash: md5
      md5: 8a6efe7b96fcf5e8014ce4e0a2b6795c
      size: 4081
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
        train.model:
          seed: 42
        train.training:
          lr: 0.00025
          lr_decay_rate: 0.0005
          lr_sched_step_size:
          lr_sched_gamma:
          save_ckpt: false
          es_patience:
          epochs: 5
          precision: 32-true
    outs:
    - path: out/lightning_logs
      hash: md5
      md5: 8e2ad85922b4ee28536b4323bf856497.dir
      size: 594764185
      nfiles: 4
    - path: out/metrics.json
      hash: md5
      md5: 10ef10c46a11796a10f6dca9aa1972e1
      size: 258
    - path: out/model.ckpt
      hash: md5
      md5: f570335bdb9ffe3ee185cd912bc24cf2
      size: 297377408
  evaluate:
    cmd: python3 src/3_evaluate.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: f570335bdb9ffe3ee185cd912bc24cf2
      size: 297377408
    - path: src/3_evaluate.py
      hash: md5
      md5: a3df4482e08745ac8d675a0418f2633a
      size: 2402
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
    outs:
    - path: data/evaluate
      hash: md5
      md5: 86495b8d2b2d73796ecbc655b9531256.dir
      size: 772528
      nfiles: 6
