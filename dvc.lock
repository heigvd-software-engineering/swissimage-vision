schema: '2.0'
stages:
  preview:
    cmd: python3 src/2_preview.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: d1e9ebadcab86d64547ead0e652b3fb9
      size: 1510
    - path: src/2_preview.py
      hash: md5
      md5: dd1aacb75a053a63d977a7f878fe653c
      size: 2205
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
    outs:
    - path: data/preview
      hash: md5
      md5: 0493dbf8a7b2bb2912b1ccc62a648673.dir
      size: 1046335
      nfiles: 4
  train:
    cmd: python3 src/2_train.py
    deps:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: 5777c717b91b9bd52f1354b24d3bc9dd
      size: 25439
    - path: src/2_train.py
      hash: md5
      md5: fb2d70b03e73bdecdbd1ee500edf357e
      size: 3885
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
        train.model:
          seed: 42
          num_classes: 2
          trainable_backbone_layers: 3
        train.training:
          lr: 0.0075
          lr_momentum: 0.9
          lr_decay_rate: 0.0005
          lr_sched_step_size: 5
          lr_sched_gamma: 0.8
          save_ckpt: false
          es_patience:
          epochs: 5
          precision: 16-mixed
    outs:
    - path: lightning_logs
      hash: md5
      md5: 555f294d457d7155a0be54d496a2f907.dir
      size: 691167636
      nfiles: 4
    - path: out/model.ckpt
      hash: md5
      md5: 75ee5167676442a8cafd6d4c00b454db
      size: 345578536
  evaluate:
    cmd: python3 src/3_evaluate.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: 75ee5167676442a8cafd6d4c00b454db
      size: 345578536
    - path: src/3_evaluate.py
      hash: md5
      md5: 72bd7e68835278190fc189f77ebad50f
      size: 2289
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 384
    outs:
    - path: data/evaluate
      hash: md5
      md5: 7c7e030ca4e1234ab7d273895a90c6e3.dir
      size: 2739742
      nfiles: 10
  prepare:
    cmd: python3 src/0_prepare.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_prepare.py
      hash: md5
      md5: 0c360e59d6219194572d25f492ffe630
      size: 1085
    params:
      params.yaml:
        prepare:
          src_bucket: swissimage-0.1m
          s3_src_vrt_path: files.vrt
          s3_dest_prepared_path: data/prepared
          commune_name: Nyon
          commune_x_ratio: 0.66
          commune_y_ratio: 0.75
          tile_size: 1024
    outs:
    - path: data/prepared/depends.txt
      hash: md5
      md5: b04bb8a84303df415975f0342f6c6452
      size: 86
  detect:
    cmd: python3 src/detect_tif.py
    deps:
    - path: data/raw/nyon.tif
      hash: md5
      md5: bc7ea13eb06a246207e8fba8fec1a82b
      size: 3679034256
    - path: out/model.ckpt
      hash: md5
      md5: 323fa405a58cbbdc6bc2714e1ecadf7f
      size: 345578472
    - path: src/detect_tif.py
      hash: md5
      md5: 55b60bb2755cef959e916c19dfb523c2
      size: 7263
    params:
      params.yaml:
        datamodule.batch_size: 16
        datamodule.image_size: 384
        train.seed: 42
    outs:
    - path: out/nyon_solar.gpkg
      hash: md5
      md5: 21947923c7a23dae7611e8b053fe6685
      size: 311296
  export:
    cmd: python3 src/3_export.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: 75ee5167676442a8cafd6d4c00b454db
      size: 345578536
    - path: src/3_export.py
      hash: md5
      md5: 59a8788833533e7f0588db33e891b721
      size: 2716
    params:
      params.yaml:
        export.model_name: solar_model_gpu
        train.datamodule.setup.batch_size: 16
        train.datamodule.setup.image_size: 384
    outs:
    - path: out/solar_model_gpu.bentomodel
      hash: md5
      md5: add9362269e48d7936b0ff35e65442e4
      size: 159963296
  extract_tiles:
    cmd: python3 src/0_extract_tiles.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_extract_tiles.py
      hash: md5
      md5: d8f3c3f85cb8ce0f03bc2f5cb6d268f2
      size: 5549
    params:
      params.yaml:
        extract_tiles:
          commune_name: Nyon
          x_ratio: 0.66
          y_ratio: 0.75
          tile_size: 1024
          overlap_size: 0
    outs:
    - path: data/extracted
      hash: md5
      md5: 21ebad90556c18bcb102a899cbaec28a.dir
      size: 2232518327
      nfiles: 1110
  pull_labels:
    cmd: python3 src/1_pull_labels.py
    deps:
    - path: src/1_pull_labels.py
      hash: md5
      md5: 9a8d04cb37fda408fb573066a7f58d3d
      size: 196
    outs:
    - path: data/labels/annotations.json
      hash: md5
      md5: d751713988987e9331980363e24189ce
      size: 2
  preprocess:
    cmd: python3 src/1_preprocess.py
    deps:
    - path: src/1_preprocess.py
      hash: md5
      md5: aa699e9faef007f37a7aac0129c4f4ff
      size: 2312
    outs:
    - path: data/preprocessed/annotations.json
      hash: md5
      md5: d1e9ebadcab86d64547ead0e652b3fb9
      size: 1510
