schema: '2.0'
stages:
  pre-train:
    cmd: python3 src/0_pre_train.py
    deps:
    - path: data/raw/bdappv.zip
      hash: md5
      md5: 451493b63927342d1dc54a365f136302
      size: 8185439624
    - path: src/0_pre_train.py
      hash: md5
      md5: 87b7e6dde1aadd5325d297fecae8f610
      size: 3944
    params:
      params.yaml:
        pre-train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
        pre-train.model:
          seed: 64
          num_classes: 1
          freeze_backbone: false
        pre-train.training:
          lr: 0.00025
          lr_decay_rate: 0.0005
          lr_sched_step_size: 1
          lr_sched_gamma: 0.7
          save_ckpt: false
          es_patience:
          epochs: 5
          precision: 32-true
    outs:
    - path: out/pre-train/lightning_logs
      hash: md5
      md5: d825bd03fe207e6b574b536adf6129bb.dir
      size: 971165669
      nfiles: 4
    - path: out/pre-train/metrics.json
      hash: md5
      md5: b843d03a6cd2eede1cb93db1252022b5
      size: 258
    - path: out/pre-train/model.ckpt
      hash: md5
      md5: b53fe6b8957e37e209c8154895acd86d
      size: 485571206
  preprocess:
    cmd: python3 src/1_preprocess.py
    deps:
    - path: out/prepare/depends.txt
      hash: md5
      md5: 50d64d0a8c63718fc2a4e718440d52af
      size: 85
    - path: src/1_preprocess.py
      hash: md5
      md5: 75265ec54a11048259cd1953dbc8f86f
      size: 2388
    outs:
    - path: out/preprocess/annotations.json
      hash: md5
      md5: ac05926286b5dbb872aaf97f14d13ff8
      size: 1619
  preview:
    cmd: python3 src/2_preview.py
    deps:
    - path: out/preprocess/annotations.json
      hash: md5
      md5: ac05926286b5dbb872aaf97f14d13ff8
      size: 1619
    - path: src/2_preview.py
      hash: md5
      md5: 6af9b4be31d221a8a5c9b39b2d53875d
      size: 2247
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
    outs:
    - path: out/preview
      hash: md5
      md5: 9fa3486d79870821035b3bf360cf2bb2.dir
      size: 746083
      nfiles: 6
  train:
    cmd: python3 src/2_train.py
    deps:
    - path: out/pre-train/model.ckpt
      hash: md5
      md5: b53fe6b8957e37e209c8154895acd86d
      size: 485571206
    - path: out/preprocess/annotations.json
      hash: md5
      md5: ac05926286b5dbb872aaf97f14d13ff8
      size: 1619
    - path: src/2_train.py
      hash: md5
      md5: f6985b5ff8585af9bc31b91318405bea
      size: 4250
    outs:
    - path: out/train/model.ckpt
      hash: md5
      md5: b53fe6b8957e37e209c8154895acd86d
      size: 485571206
  export:
    cmd: python3 src/3_export.py
    deps:
    - path: out/train/model.ckpt
      hash: md5
      md5: b53fe6b8957e37e209c8154895acd86d
      size: 485571206
    - path: src/3_export.py
      hash: md5
      md5: 74dd961afc4a6a5768d59749be4b6929
      size: 2850
    params:
      params.yaml:
        export.model_name: solar_model_gpu
        train.datamodule.setup.batch_size: 16
        train.datamodule.setup.image_size: 256
    outs:
    - path: out/export/solar_model_gpu.bentomodel
      hash: md5
      md5: 2ed223371c233eaf89afa03e8dc0f78e
      size: 126725060
  evaluate:
    cmd: python3 src/3_evaluate.py
    deps:
    - path: out/train/model.ckpt
      hash: md5
      md5: b53fe6b8957e37e209c8154895acd86d
      size: 485571206
    - path: src/3_evaluate.py
      hash: md5
      md5: bd5b03a98b3ad2ade158897cc0fa5062
      size: 2404
    params:
      params.yaml:
        train.datamodule.setup:
          seed: 42
          split: 0.8
          batch_size: 16
          image_size: 256
    outs:
    - path: out/evaluate
      hash: md5
      md5: 4560ef5a19deb8ab3b562d4f951566e3.dir
      size: 240863
      nfiles: 2
  prepare:
    cmd: python3 src/0_prepare.py
    deps:
    - path: data/raw/swissBOUNDARIES3D_1_5_LV95_LN02.gpkg
      hash: md5
      md5: f6f20f6b2a2e76e976e5bc5fb22d06a2
      size: 73265152
    - path: src/0_prepare.py
      hash: md5
      md5: 1d9769452f61fe38bb228751145dff6c
      size: 1085
    params:
      params.yaml:
        prepare:
          src_bucket: swissimage-0.1m
          s3_src_vrt_path: files.vrt
          s3_dest_prepared_path: data/prepared
          commune_name: Nyon
          commune_x_ratio: 0.66
          commune_y_ratio: 0.75
          tile_size: 512
    outs:
    - path: out/prepare/depends.txt
      hash: md5
      md5: 50d64d0a8c63718fc2a4e718440d52af
      size: 85
